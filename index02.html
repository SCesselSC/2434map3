
<!--<!DOCTYPE html>-->
<html lang="ja">

<head>

	<meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="test.css" >
	<link rel="icon" type="image/png" href="./img/favicon.png">
	<script src="script/openseadragon.js"></script>
	<title>2434map</title>

<script>
//addHandler関数
function attachZoomHandler(viewer, zoomFactor){//各地図の倍率のための設定
    
    viewer.zoomFactor = zoomFactor;
    function updateScale(){
        const zoom = viewer.viewport.getZoom(true);	// 現在の倍率
        const scale = zoom * viewer.zoomFactor;		// 最小倍率を基準にスケーリング

        viewer.element.querySelectorAll('.map-marker').forEach(el => {
            const initial = el.dataset.initialTransform || "";
	    const match = initial.match(/scale\((.+)\)/);
	    const initialScale = match ? parseFloat(match[1]) : 1; // match がなければ 1 を使う
            el.style.transform = `${initial} scale(${scale / initialScale})`;
        });
    }

    // viewerに関数を持たせておく
    viewer.updateMarkerScale = updateScale;

    // 初期化＆ズーム時に呼び出す
    viewer.addHandler('viewport-change', updateScale);
    viewer.addHandler('open', updateScale);
    viewer.addHandler('animation', updateScale); // ズームアニメーション対応

    // 初期表示時も適用
    updateScale();
}//addHandler end

// ▼ CSV読み込み
function loadMarkers(viewer, csvFile){

  fetch(csvFile)
    .then(res => res.text())
    .then(text => {

      const rows = text.split("\n").slice(1);

      rows.forEach(row => {
	// 文字列中のカンマや改行を正しく扱う(現在無効)
  	//if(!cols || cols.length < 8) return;// 列が足りなければスキップ

        const [x,z,label,zahyouFlag,icon,spriteX,spriteY,iconSize] = row.split(",");

	// 数値化と空文字チェック
        const xi = parseFloat(x);
        const zi = parseFloat(z);		// Zを画像Y座標として扱う
        const sX = parseInt(spriteX) || 1;
        const sY = parseInt(spriteY) || 1;
	const size = parseFloat(iconSize) || 0;
	if(isNaN(xi) || isNaN(zi)) return;

        addMarker(viewer, xi, zi, label,zahyouFlag, icon, sX, sY, size);
      });

      // ★ マーカー追加後に1フレーム待ってから正しいscale適用
      requestAnimationFrame(() => {
        if (viewer.updateMarkerScale) {
          viewer.updateMarkerScale();
        }
      });

    });
}//loadMarkers end

</script>

<style type="text/css">



#_TOP2{
	margin:10px;
	width:15000px;/*ここを固定長にしないとブラウザの横幅に従って変形する*/
	float:left;
	/*border:1px solid blue;テスト用*/
}
#_TOP2 img {/*こう書けば_TOP以下の全部のimgに反映される*/
	margin:0;/*img毎、隣との隙間をなくす*/
	float:left;/*左上から積み下げていく*/
	/*vertical-align: middle;*/
}



.relative {
    position: relative; /*relative*/
	width: 15000px;
	height: 12000px;
}



/*
.site-header{
    position: fixed;
}
*/


/*中央拠点*/
.Center {
    position: absolute;
	right: 2000px;
	bottom: -8500px;
}


/*井戸先*/
.well {
    position: absolute; /*absolute*/
	right: 13000px;
	bottom: -2800px;
}


/*openseadragonの地図をクリック拡大すると上部タブが消えるための対応*/
.osd_disp{
	height: 96%;
}

/*タブ部分*/
.navi {
    height: 20px;
    position: fixed;
    z-index: 999;
}

#a1 {
	position: absolute;
}
#a2 {
	position: absolute;
}

.map-marker{
 /* transform: translate(-50%, -100%);	一旦削除 */
  transform-origin: center center; /* アイコンの中心を基準に拡大 */
  /* transform: scale(0.3);          /* 初期倍率に応じて小さくする */
  /* transition: transform 0.2s; マーカー 0.2秒遅延アニメーション 不要 */

  text-align: center;
  font-size: 6px; /* 文字サイズを調整 */
}
.map-marker img {
    width: 24px; /* アイコンの大きさ */
}
.marker-icon{
  width: 32px;
}

.marker-label{
  font-size: 12px;
  background: white;
  padding: 2px 6px;
  border-radius: 6px;
  border: 1px solid #333;
  margin-top: 2px;
  white-space: nowrap;
}

</style>
</head>


<body>
<a name="wrap"></a>
<div class="cp_tab">
	
	<input type="radio" name="cp_tab" id="tab1_1" aria-controls="normal_tab01" checked>
	<label for="tab1_1">通常地図</label>

	<input type="radio" name="cp_tab" id="tab1_2" aria-controls="all_tab01">
	<label for="tab1_2">全体地図</label>

	<input type="radio" name="cp_tab" id="tab1_3" aria-controls="nether_tab01">
	<label for="tab1_3">ネザー地図</label>

	<input type="radio" name="cp_tab" id="tab1_4" aria-controls="land_tab01">
	<label for="tab1_4">にじさんじランド</label>

	<input type="radio" name="cp_tab" id="tab1_5" aria-controls="newworld_tab01">
	<label for="tab1_5">新鯖通常地図</label>


	<input type="radio" name="cp_tab" id="tab1_6" aria-controls="newworld_all_tab01">
	<label for="tab1_6">新鯖全体地図</label>


	<input type="radio" name="cp_tab" id="tab1_7" aria-controls="newworld_nether_tab01">
	<label for="tab1_7">新鯖ネザー</label>

	<input type="radio" name="cp_tab" id="tab1_8" aria-controls="sakura_tab01">
	<label for="tab1_8">桜ンボ村</label>
		
	<input type="radio" name="cp_tab" id="tab1_9" aria-controls="ark_tab01">
	<label for="tab1_9">夏祭り会場2023</label>
<!--
	<input type="radio" name="cp_tab" id="tab1_10" aria-controls="member_tab01">
	<label for="tab1_10">ライバー参考</label>
-->
<!--
	<input type="radio" name="cp_tab" id="tab1_11" aria-controls="etc_tab01">
	<label for="tab1_11">他(連絡先等)</label>
-->
<!--
	<input type="radio" name="cp_tab" id="tab1_12" aria-controls="ex_tab01">
	<label for="tab1_12">試験運用</label>
-->
<div class="cp_tabpanels">




<!--通常地図タブ-->
<div id="normal_tab01" class="cp_tabpanel">
	<div id="contentDiv_main" class="osd_disp"></div>
	<script type="text/javascript">

		var viewer_2434map_main = OpenSeadragon({
			showNavigator: true,
			id:              "contentDiv_main",
			prefixUrl:       "2434map_files/",
			tileSources:     "2434map.xml"
		});
		// 通常地図タブに乗せるアイコンの倍率をセット 拡大倍率 値が大きいほど、拡大スピードが速い
		viewer_2434map_main.zoomFactor = 0.4;
	
		// 拡大縮小ハンドラーを登録
		attachZoomHandler(viewer_2434map_main, viewer_2434map_main.zoomFactor);

		viewer_2434map_main.addHandler('open', function(){
		   loadMarkers(viewer_2434map_main, "2434map_marker.csv");
		   //attachZoomHandler(viewer_2434map_main,0.4);	
		});
	</script>
</div>






<!--全体地図タブ-->
<div id="all_tab01" class="cp_tabpanel">
	<div id="contentDiv_all" class="osd_disp"></div>
	<script type="text/javascript">
		var viewer_2434map_all = OpenSeadragon({
			showNavigator: true,
			id:              "contentDiv_all",
			prefixUrl:       "2434map_all_files/",
			tileSources:     "2434map_all.xml"
		});
		// 全体地図タブに乗せるアイコンの倍率をセット 拡大倍率 値が大きいほど、拡大スピードが速い
		viewer_2434map_all.zoomFactor = 0.2;
	
		// 拡大縮小ハンドラーを登録
		attachZoomHandler(viewer_2434map_all, viewer_2434map_all.zoomFactor);

		viewer_2434map_all.addHandler('open', function(){
		   loadMarkers(viewer_2434map_all, "2434map_all_marker.csv");
		   //attachZoomHandler(viewer_2434map_all, 0.2);
		});
	</script>
</div>



<!-- 全体地図の旧ファイル分割式
<div id="all_tab01" class="cp_tabpanel">
	
	<div class="navi">
		<a href="#wrap" class="btn-flat-vertical-border">メニューへ</a>
		<a href="#a1" class="btn-flat-vertical-border">中央拠点へ</a>
		<a href="#a2" class="btn-flat-vertical-border">井戸の先へ</a>
	</div>

	<div class="relative">
		<div id="a1" class="Center"></div>
		<div id="a2" class="well"></div>
	</div>

		<div id="_TOP2">
			<img src="img/all-a01.png"><img src="img/all-a02.png"><img src="img/all-a03.png"><img src="img/all-a04.png"><img src="img/all-a05.png">
			<img src="img/all-b01.png"><img src="img/all-b02.png"><img src="img/all-b03.png"><img src="img/all-b04.png"><img src="img/all-b05.png">
			<img src="img/all-c01.png"><img src="img/all-c02.png"><img src="img/all-c03.png"><img src="img/all-c04.png"><img src="img/all-c05.png">
			<img src="img/all-d01.png"><img src="img/all-d02.png"><img src="img/all-d03.png"><img src="img/all-d04.png"><img src="img/all-d05.png">
		</div>
</div>
-->




<!--ネザー地図タブ-->
<div id="nether_tab01" class="cp_tabpanel">
	<div id="contentDiv_nether" class="osd_disp"></div>
	<script type="text/javascript">
		var viewer_2434map_nether = OpenSeadragon({
			showNavigator: true,
			id:              "contentDiv_nether",
			prefixUrl:       "2434map_nether_files/",
			tileSources:     "2434map_nether.xml"
		});
		// ネザー地図タブに乗せるアイコンの倍率をセット 拡大倍率 値が大きいほど、拡大スピードが速い
		viewer_2434map_nether.zoomFactor = 0.6;
	
		// 拡大縮小ハンドラーを登録
		attachZoomHandler(viewer_2434map_nether, viewer_2434map_nether.zoomFactor);

		viewer_2434map_nether.addHandler('open', function(){
		   loadMarkers(viewer_2434map_nether, "2434map_nether_marker.csv");
		   //attachZoomHandler(viewer_2434map_nether, 0.6);
		});
	</script>
</div>


<!--にじさんじランドタブ-->
<div id="land_tab01" class="cp_tabpanel">
	<p id="PageTopBtn"><a href="#wrap">▲</a></p>
	<img src="img/2434map_land.png">
</div>


<!--新規開拓ワールドタブ-->
<div id="newworld_tab01" class="cp_tabpanel">
	<div id="contentDiv_new" class="osd_disp"></div>
	<script type="text/javascript">
		var viewer_2434map_new = OpenSeadragon({
			showNavigator: true,
			id:              "contentDiv_new",
			prefixUrl:       "2434map_new_files/",
			tileSources:     "2434map_new.xml"
		});
		// 新鯖通常地図タブに乗せるアイコンの倍率をセット 拡大倍率 値が大きいほど、拡大スピードが速い
		viewer_2434map_new.zoomFactor = 0.4;
	
		// 拡大縮小ハンドラーを登録
		attachZoomHandler(viewer_2434map_new, viewer_2434map_new.zoomFactor);

		viewer_2434map_new.addHandler('open', function(){
		   loadMarkers(viewer_2434map_new, "2434map_new_marker.csv");
		   //attachZoomHandler(viewer_2434map_new, 0.4);
		});
	</script>
</div>




<!--新規開拓ワールド全体タブ-->
<div id="newworld_all_tab01" class="cp_tabpanel">
	<div id="contentDiv_new_all" class="osd_disp"></div>
	<script type="text/javascript">
		var viewer_2434map_new_all = OpenSeadragon({
			showNavigator: true,
			id:              "contentDiv_new_all",
			prefixUrl:       "2434map_new_all_files/",
			tileSources:     "2434map_new_all.xml"
		});
		// 新鯖全体地図タブに乗せるアイコンの倍率をセット 拡大倍率 値が大きいほど、拡大スピードが速い
		viewer_2434map_new_all.zoomFactor = 0.2;
	
		// 拡大縮小ハンドラーを登録
		attachZoomHandler(viewer_2434map_new_all, viewer_2434map_new_all.zoomFactor);

		viewer_2434map_new_all.addHandler('open', function(){
		   loadMarkers(viewer_2434map_new_all, "2434map_new_all_marker.csv");
		   //attachZoomHandler(viewer_2434map_new_all, 0.2);
		});
	</script>
</div>




<!--新規開拓ワールドネザータブ-->
<div id="newworld_nether_tab01" class="cp_tabpanel">
	<div id="contentDiv_new_nether" class="osd_disp"></div>
	<script type="text/javascript">
		var viewer_2434map_new_nether = OpenSeadragon({
			showNavigator: true,
			id:              "contentDiv_new_nether",
			prefixUrl:       "2434map_new_nether_files/",
			tileSources:     "2434map_new_nether.xml"
		});
		// 新鯖ネザー地図タブに乗せるアイコンの倍率をセット 拡大倍率 値が大きいほど、拡大スピードが速い
		viewer_2434map_new_nether.zoomFactor = 0.6;
	
		// 拡大縮小ハンドラーを登録
		attachZoomHandler(viewer_2434map_new_nether, viewer_2434map_new_nether.zoomFactor);

		viewer_2434map_new_nether.addHandler('open', function(){
		   loadMarkers(viewer_2434map_new_nether, "2434map_new_nether_marker.csv");
		   //attachZoomHandler(viewer_2434map_new_nether, 0.6);
		});
	</script>
</div>


<!--桜ンボ村タブ-->
<div id="sakura_tab01" class="cp_tabpanel">
	<p id="PageTopBtn"><a href="#wrap">▲</a></p>
	<img src="img/2434map_nbo.png">
</div>


<!--お祭り会場2023タブ-->
<div id="ark_tab01" class="cp_tabpanel">
	<div id="contentDiv_omatsuri2023" class="osd_disp"></div>
	<script type="text/javascript">
		var viewer_omatsuri2023 = OpenSeadragon({
			showNavigator: true,
			id:              "contentDiv_omatsuri2023",
			prefixUrl:       "omatsuri2023_files/",
			tileSources:     "omatsuri2023.xml"
		});
		viewer_omatsuri2023.addHandler('open', function(){
		   loadMarkers(viewer_omatsuri2023, "omatsuri2023_marker.csv");
		});
	</script>
</div>


<script>
// マーカー設置追加関数
function addMarker(viewer, imageX, imageY, label, zahyouFlag, icon, spriteX, spriteY, iconSize){

  const viewportPoint =  viewer.viewport.imageToViewportCoordinates(imageX, imageY);

  const el = document.createElement("div");
  el.className = "map-marker";

  // 1セルのサイズ
  const imageSize = 176;     // 元画像サイズ
  const gridCount = 4;       // 4×4分割
  const cellSize = imageSize / gridCount;

// 文字サイズ設定
  const markerStyle = {
    scale: 1.2,             // 表示倍率
    fontSize: "14px",       // 文字サイズ
    fontWeight: "bold",     // 太字
    iconSize: iconSize || 24 // アイコンサイズ（デフォルト24px）
  };

  // アイコン画像がある場合のみ表示
  let iconHTML = "";
  if(icon && iconSize > 0){
    iconHTML = `
    <div class="marker-icon-sprite"
         style="
           width:${iconSize}px;
           height:${iconSize}px;
           background-image:url(${icon});
           background-position:-${cellSize*(spriteX-1)}px -${cellSize*(spriteY-1)}px;
           background-size:${imageSize}px ${imageSize}px;
	   margin:0;
         ">
    </div>`;
  }

  // 文字がある場合のみ表示
  let labelHTML = "";
  if(label && label.trim() !== ""){
	if(zahyouFlag && (zahyouFlag.trim() === "はい" ||zahyouFlag.toLowerCase() === "yes"||zahyouFlag.toLowerCase() === "on")){

    labelHTML = `
      <div style="line-height:1.2; font-size:${markerStyle.fontSize};font-weight:${markerStyle.fontWeight};">
        ${label}<br>
        <span style="font-size:5px; opacity:0.7;">
          ${imageX} ${imageY}
        </span>
      </div>
    `;

  } else {
    labelHTML = `<div style="margin:0; line-height:1; font-size:${markerStyle.fontSize};font-weight:${markerStyle.fontWeight};">${label}</div>`;
  }
}
  // HTMLにまとめる
  el.innerHTML = iconHTML + labelHTML;


  // OpenSeadragon でズームに追従させる
  viewer.addOverlay({
    element: el,
     location: viewer.viewport.imageToViewportCoordinates(imageX, imageY),
    placement: "CENTER"  // 中心に合わせる
  });


// ★ scale は open 後に計算する
  viewer.addHandler('open', function(){

// ★ ここで直接スケール適用
if (viewer.updateMarkerScale) {
  setTimeout(() => {
    viewer.updateMarkerScale();
  }, 0);
}

 // ★ 初期 scale をタブごとに設定
    const zoom = viewer.viewport.getZoom(true);
    const scale = zoom * (viewer.zoomFactor || 0.4); // viewer.zoomFactor があれば使う 安全のためのデフォルト値0.4(目安)
    el.style.transform = `scale(${scale})`;


// 初期 transform を保持しておく
  const initialTransform = el.style.transform;
  el.dataset.initialTransform = initialTransform;
 });

}//addMarker end




// 正しい初期ズーム
document.querySelectorAll('input[name="cp_tab"]').forEach(tab => {
  tab.addEventListener('change', function(){

    setTimeout(() => {

      [
        viewer_2434map_main,
        viewer_2434map_all,
        viewer_2434map_nether,
        viewer_2434map_new,
        viewer_2434map_new_all,
        viewer_2434map_new_nether,
        viewer_omatsuri2023
      ].forEach(v => {
        if (!v) return;
        //v.forceResize();        // サイズ再取得
        v.viewport.goHome(true); // 正しい初期ズームへ
      });

    }, 30);

  });
});



</script>



<!--ライバー参考タブ
<div id="member_tab01" class="cp_tabpanel">
		<img src="img/2434member.png"><br><br>
		<img src="img/2434birthday.png">
</div>
-->

<!--他(連絡先)タブ-->
<div id="etc_tab01" class="cp_tabpanel">
		<br>
2434map 1	にじさんじサーバーまとめ/名所 > 地図画像下の<a href="https://2434map.github.io/1/">[地図ブラウズ]</a>リンクから　更新2019年頃まで。<br>
2434map 2	にじさんじサーバーまとめ <a href="https://cyokin.cloudfree.jp/2434map.html">地図画像リンク</a>から 更新2022年9月頃まで。<br>
</div>


<!--試験運用タブ-->

<!--
<div id="ex_tab01" class="cp_tabpanel">
	<div id="contentDiv_ex" class="osd_disp"></div>
	<script type="text/javascript">
		OpenSeadragon({
			showNavigator: true,
			id:              "contentDiv_ex",
			prefixUrl:       "2434map_all_files/",
			tileSources:     "2434map_all.xml"
		});
	</script>
</div>
-->

</body>

</html>