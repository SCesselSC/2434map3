<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>DeepZoom ベクターレイヤー拡張版</title>
<script src="https://openseadragon.github.io/openseadragon/openseadragon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  .osd_disp { width: 7166px; height: 7166px; position: relative; border:1px solid #ccc; margin-bottom:10px; }
  canvas { position: absolute; top:0; left:0; pointer-events: auto; }
</style>
</head>
<body>
<h2>DeepZoom + ベクターレイヤー拡張サンプル</h2>

<div>
  <div id="viewer_main" class="osd_disp"></div>
  <canvas id="overlay_main"></canvas>
  <button id="save_main">保存</button>
</div>

<script>
// ----------------- Supabase設定 -----------------
const supabaseUrl = 'https://sbwfgkzmruesocvzvkur.supabase.co';
const supabaseKey = 'sb_publishable_aaBZ938HOWD6-v3XTtypfA_7ZdoizBh';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// ----------------- データ -----------------
let annotations = []; // {type:'text'|'line'|'icon', ...}

// ----------------- OpenSeadragon 初期化 -----------------
const viewer = OpenSeadragon({
    id: "viewer_main",
    prefixUrl: "2434map_new_files/",
    tileSources: "2434map_new.xml",
    showNavigator: true
});

// ----------------- Canvasレイヤー -----------------
const overlay = document.getElementById('overlay_main');
overlay.width = 7166;
overlay.height = 7166;
overlay.style.left = viewer.container.offsetLeft + 'px';
overlay.style.top  = viewer.container.offsetTop + 'px';
const ctx = overlay.getContext('2d');


// ==== クリックで文字入力 & 即描画 ====
overlay.addEventListener('click', function(e){
  const rect = overlay.getBoundingClientRect();
  const x = (e.clientX - rect.left) / overlay.width;
  const y = (e.clientY - rect.top) / overlay.height;

  const inputText = prompt("文字を入力してください"); //  OKで文字取得
  if(!inputText) return; // キャンセルなら終了

  // annotations に追加
  annotations.push({x, y, color:'red', text: inputText});

  // 画面に即反映
  drawAnnotations();
});


// ----------------- 描画関数 -----------------
function drawAnnotations(){
    ctx.clearRect(0,0,overlay.width, overlay.height);
    annotations.forEach(dot=>{
    // マーカー
    ctx.fillStyle = dot.color;
    ctx.beginPath();
    ctx.arc(dot.x*overlay.width, dot.y*overlay.height,5,0,2*Math.PI);
    ctx.fill();
    // 文字
    if(dot.text){
      ctx.fillStyle = 'black';
      ctx.font = '14px sans-serif';
      ctx.fillText(dot.text, dot.x*overlay.width + 6, dot.y*overlay.height - 6);
    }
  });
}



// ----------------- 保存 -----------------
document.getElementById('save_main').addEventListener('click', async ()=>{
    const { data, error } = await supabaseClient
        .from('test01')
        .insert([{data: annotations}]);
    if(error) alert("保存エラー: "+error.message);
    else alert("保存完了！");
});

// ----------------- 読み込み -----------------
async function loadAnnotations(){
    const { data, error } = await supabaseClient
        .from('test01')
        .select('data');
    if(data){
        data.forEach(row=>{
            if(row.data) annotations.push(...row.data);
        });
        drawAnnotations();
    }
}

loadAnnotations();

</script>
</body>
</html>
